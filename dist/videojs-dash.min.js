/*! @name videojs-contrib-dash @version 2.11.1 @license Apache-2.0 */
!function(e,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a(require("dashjs"),require("video.js"),require("global/window"),require("global/document")):"function"==typeof define&&define.amd?define(["dashjs","video.js","global/window","global/document"],a):e.videojsDash=a(e.dashjs,e.videojs,e.window,e.document)}(this,function(d,u,o,t){"use strict";function s(i,e){var r=i.dash.mediaPlayer,n=r.getTracksFor("audio"),o=i.audioTracks();function s(e){return"dash-audio-"+e}o.length&&e.clearTracks(["audio"]);var l=r.getCurrentTrackFor("audio");n.forEach(function(e){var a,t;if(Array.isArray(e.labels))for(var r=0;r<e.labels.length;r++)if(e.labels[r].lang&&-1!==i.language().indexOf(e.labels[r].lang.toLowerCase())){a=e.labels[r];break}a?t=a.text:Array.isArray(e.labels)&&1===e.labels.length?t=e.labels[0].text:(t=e.lang,e.roles&&e.roles.length&&(t+=" ("+e.roles.join(", ")+")")),o.addTrack(new u.AudioTrack({enabled:e===l,id:s(e.index),kind:e.kind||"main",label:t,language:e.lang}))});function a(){for(var e=0;e<o.length;e++){var a,t=o[e];t.enabled&&(a=function(e,a){return e.find(function(e){return s(e.index)===a.id})}(n,t),r.setCurrentTrack(a))}}o.addEventListener("change",a),i.dash.mediaPlayer.on(d.MediaPlayer.events.STREAM_TEARDOWN_COMPLETE,function(){o.removeEventListener("change",a)})}function l(o,e,s){var l=[],a=s.map(function(e){var a;if(Array.isArray(e.labels))for(var t=0;t<e.labels.length;t++)if(e.labels[t].lang&&-1!==o.language().indexOf(e.labels[t].lang.toLowerCase())){a=e.labels[t];break}return{dashTrack:e,trackConfig:{label:a?a.text:Array.isArray(e.labels)&&1===e.labels.length?e.labels[0].text:e.lang||e.label,language:e.lang,srclang:e.lang,kind:e.kind}}}).map(function(e){var a=e.trackConfig,t=e.dashTrack,r=o.addRemoteTextTrack(a,!1);return l.push({textTrack:r.track,dashTrack:t}),r});function t(){for(var e=o.dash.mediaPlayer,i=o.textTracks(),n=-1,a=0;a<i.length;a+=1)!function(e){var a,t,r=i[e];"showing"!==r.mode||(t=(a=function(e,a){for(var t=0;t<e.length;t++)if(a(e[t]))return e[t]}(l,function(e){return e.textTrack===r}))?a.dashTrack:null)&&(n=s.indexOf(t))}(a);n!==e.getCurrentTextTrackIndex()&&e.setTextTrack(n)}return o.textTracks().on("change",t),o.dash.mediaPlayer.on(d.MediaPlayer.events.STREAM_TEARDOWN_COMPLETE,function(){o.textTracks().off("change",t)}),t(),a}function c(t,e,a){o.VTTCue&&!/\[native code\]/.test(o.VTTCue.toString())&&(o.VTTCue=!1);var r,i=[];function n(e){e.index;var a=e.tracks;r.off(d.MediaPlayer.events.TEXT_TRACKS_ADDED,n),i.forEach(t.removeRemoteTextTrack.bind(t)),i=[],a.length&&(i=l(t,0,a))}e.featuresNativeTextTracks?u.log.error("You must pass {html: {nativeCaptions: false}} in the videojs constructor to use text tracks in videojs-contrib-dash"):((r=t.dash.mediaPlayer).on(d.MediaPlayer.events.TEXT_TRACKS_ADDED,n),r.on(d.MediaPlayer.events.CAN_PLAY,function(){r.off(d.MediaPlayer.events.TEXT_TRACKS_ADDED,n)}))}d=d&&d.hasOwnProperty("default")?d.default:d,u=u&&u.hasOwnProperty("default")?u.default:u,o=o&&o.hasOwnProperty("default")?o.default:o,t=t&&t.hasOwnProperty("default")?t.default:t;var r=function(){function r(a,e,i){var t,n=this;i=i||e.options_,this.player=u(i.playerId),this.player.dash=this.player.dash||{},this.tech_=e,this.el_=e.el(),this.elParent_=this.el_.parentNode,this.hasFiniteDuration_=!1,a.src&&(e.isReady_=!1,r.updateSourceData&&(u.log.warn('updateSourceData has been deprecated. Please switch to using hook("updatesource", callback).'),a=r.updateSourceData(a)),r.hooks("updatesource").forEach(function(e){a=e(a)}),t=a.src,this.keySystemOptions_=r.buildDashJSProtData(a.keySystemOptions),this.player.dash.mediaPlayer=d.MediaPlayer().create(),this.mediaPlayer_=this.player.dash.mediaPlayer,this.mediaPlayer_.setTextDefaultEnabled(!1),r.useVideoJSDebug&&(u.log.warn('useVideoJSDebug has been deprecated. Please switch to using hook("beforeinitialize", callback).'),r.useVideoJSDebug(this.mediaPlayer_)),r.beforeInitialize&&(u.log.warn('beforeInitialize has been deprecated. Please switch to using hook("beforeinitialize", callback).'),r.beforeInitialize(this.player,this.mediaPlayer_)),r.hooks("beforeinitialize").forEach(function(e){e(n.player,n.mediaPlayer_)}),this.mediaPlayer_.initialize(),this.retriggerError_=function(e){if("capability"===e.error&&"mediasource"===e.event)n.player.error({code:4,message:"The media cannot be played because it requires a feature that your browser does not support."});else if("manifestError"!==e.error||"createParser"!==e.event.id&&"codec"!==e.event.id&&"nostreams"!==e.event.id&&"nostreamscomposed"!==e.event.id&&"parse"!==e.event.id&&"multiplexedrep"!==e.event.id)if("mediasource"===e.error)e.event.match("MEDIA_ERR_ABORTED")?n.player.error({code:1,message:e.event}):e.event.match("MEDIA_ERR_NETWORK")?n.player.error({code:2,message:e.event}):e.event.match("MEDIA_ERR_DECODE")?n.player.error({code:3,message:e.event}):e.event.match("MEDIA_ERR_SRC_NOT_SUPPORTED")?n.player.error({code:4,message:e.event}):e.event.match("MEDIA_ERR_ENCRYPTED")?n.player.error({code:5,message:e.event}):(e.event.match("UNKNOWN"),n.player.error({code:4,message:e.event}));else if("capability"===e.error&&"encryptedmedia"===e.event)n.player.error({code:5,message:"The media cannot be played because it requires encryption features that your browser does not support."});else if("key_session"===e.error)n.player.error({code:5,message:e.event});else if("download"===e.error)n.player.error({code:2,message:"The media playback was aborted because too many consecutive download errors occurred."});else{if("mssError"!==e.error)return;n.player.error({code:3,message:e.event})}else n.player.error({code:4,message:e.event.message});setTimeout(function(){n.mediaPlayer_.reset()},10)},this.mediaPlayer_.on(d.MediaPlayer.events.ERROR,this.retriggerError_),this.getDuration_=function(e){var a=e.data.Period_asArray,t=n.hasFiniteDuration_;e.data.mediaPresentationDuration||a[a.length-1].duration?n.hasFiniteDuration_=!0:n.hasFiniteDuration_=!1,n.hasFiniteDuration_!==t&&n.player.trigger("durationchange")},this.mediaPlayer_.on(d.MediaPlayer.events.MANIFEST_LOADED,this.getDuration_),i.dash&&Object.keys(i.dash).forEach(function(e){var a,t="set"+e.charAt(0).toUpperCase()+e.slice(1),r=i.dash[e];n.mediaPlayer_.hasOwnProperty(t)&&(u.log.warn("Using dash options in videojs-contrib-dash without the set prefix has been deprecated. Change '"+e+"' to '"+t+"'"),e=t),n.mediaPlayer_.hasOwnProperty(e)?(Array.isArray(r)||(r=[r]),(a=n.mediaPlayer_)[e].apply(a,r)):u.log.warn("Warning: dash configuration option unrecognized: "+e)}),this.mediaPlayer_.attachView(this.el_),this.mediaPlayer_.setAutoPlay(!1),function(e,a){e.dash.mediaPlayer.on(d.MediaPlayer.events.PLAYBACK_METADATA_LOADED,s.bind(null,e,a))}.call(null,this.player,e),c.call(null,this.player,e,i),this.setupQualityLevels_(),this.mediaPlayer_.setProtectionData(this.keySystemOptions_),this.mediaPlayer_.attachSource(t),this.tech_.triggerReady())}var e=r.prototype;return e.setupQualityLevels_=function(){var r=this,i=this.player;i&&i.qualityLevels&&(this.qualityLevels_=i.qualityLevels(),this.mediaPlayer_.on(d.MediaPlayer.events.PLAYBACK_METADATA_LOADED,function(){r.videoRates_=r.mediaPlayer_.getBitrateInfoListFor("video"),r.audioRates_=r.mediaPlayer_.getBitrateInfoListFor("audio");var a=r.videoRates_[r.videoRates_.length-1].bitrate;r.audioMapper_=r.videoRates_.map(function(e){return Math.round(e.bitrate/a*(r.audioRates_.length-1))}),r.videoRates_.forEach(function(e){r.qualityLevels_.addQualityLevel({id:e.bitrate,width:e.width,height:e.height,bandwidth:e.bitrate,enabled:function(e){if(void 0===e)return void 0===this.enabled__||this.enabled__;this.enabled__=e}})})}),this.qualityLevels_.on("change",function(e){r.mediaPlayer_=i.dash.mediaPlayer;var a=r.qualityLevels_.levels_.filter(function(e){return e.enabled}),t=r.mediaPlayer_.getSettings().streaming.abr.autoSwitchBitrate;1===a.length?(t.video&&r.mediaPlayer_.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:!1,audio:!1}}}}),r.mediaPlayer_.setQualityFor("video",e.selectedIndex),r.mediaPlayer_.setQualityFor("audio",r.audioMapper_[e.selectedIndex])):t.video||r.mediaPlayer_.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:!0,audio:!0}}}})}),this.mediaPlayer_.on(d.MediaPlayer.events.QUALITY_CHANGE_REQUESTED,function(e){"video"===e.mediaType&&(r.qualityLevels_.selectedIndex_=e.newQuality)}))},r.buildDashJSProtData=function(e){var a={};if(!e||!Array.isArray(e))return null;for(var t=0;t<e.length;t++){var r=e[t],i=u.mergeOptions({},r.options);i.licenseUrl&&(i.serverURL=i.licenseUrl,delete i.licenseUrl),a[r.name]=i}return a},e.dispose=function(){this.mediaPlayer_&&(this.mediaPlayer_.off(d.MediaPlayer.events.ERROR,this.retriggerError_),this.mediaPlayer_.off(d.MediaPlayer.events.MANIFEST_LOADED,this.getDuration_),this.mediaPlayer_.reset()),this.player.dash&&delete this.player.dash,this.qualityLevels_&&this.qualityLevels_.dispose()},e.duration=function(){return this.mediaPlayer_.isDynamic()&&!this.hasFiniteDuration_?1/0:this.mediaPlayer_.duration()},r.hooks=function(e,a){return r.hooks_[e]=r.hooks_[e]||[],a&&(r.hooks_[e]=r.hooks_[e].concat(a)),r.hooks_[e]},r.hook=function(e,a){r.hooks(e,a)},r.removeHook=function(e,a){var t=r.hooks(e).indexOf(a);return-1!==t&&(r.hooks_[e]=r.hooks_[e].slice(),r.hooks_[e].splice(t,1),!0)},r}();r.hooks_={};return u.DashSourceHandler=function(){return{canHandleSource:function(e){return function(a){a=JSON.parse(JSON.stringify(a)),r.updateSourceData&&(u.log.warn('updateSourceData has been deprecated. Please switch to using hook("updatesource", callback).'),a=r.updateSourceData(a)),r.hooks("updatesource").forEach(function(e){a=e(a)});var e=t.createElement("video");return!(a.keySystemOptions&&!o.navigator.requestMediaKeySystemAccess&&!e.msSetMediaKeys)}(e)?u.DashSourceHandler.canPlayType(e.type)?"probably":/\.mpd/i.test(e.src)?"maybe":"":""},handleSource:function(e,a,t){return new r(e,a,t)},canPlayType:function(e){return u.DashSourceHandler.canPlayType(e)}}},u.DashSourceHandler.canPlayType=function(e){return/^application\/dash\+xml/i.test(e)?"probably":""},o.MediaSource&&u.getTech("Html5").registerSourceHandler(u.DashSourceHandler(),0),u.Html5DashJS=r});
